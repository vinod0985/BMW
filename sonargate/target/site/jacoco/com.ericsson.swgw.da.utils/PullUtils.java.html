<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PullUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">eric-swgwda</a> &gt; <a href="index.source.html" class="el_package">com.ericsson.swgw.da.utils</a> &gt; <span class="el_source">PullUtils.java</span></div><h1>PullUtils.java</h1><pre class="source lang-java linenums">package com.ericsson.swgw.da.utils;

/*###################################################################################
 #  @Name           :   PullUtils.java
 #
 #  @Created        :   Oct Drop 2022
 #
 #  @Description    :   To pull packages from SW Gateway.
 #
 #  @Programmer     :   Eswar D
 #
 #  @Organization   :   HCL
 #
 #  @Release        :   MR2210
 #
 #  @History        :
 #      Xsignum/Esignum :   Date(DD-MM-YYYY)    :   description
 #      ZDARESW(Eswar)      20-Sept-2022           created pull util method to pull packages from SW gateway.
 ######################################################################################*/

import java.io.BufferedInputStream;
import java.io.BufferedReader;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URLConnection;
import java.sql.SQLException;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.http.HttpHeaders;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.codehaus.jettison.json.JSONException;

import com.ericsson.swgw.da.constants.Constants;
import com.ericsson.swgw.da.services.AzureTokenService;

public class PullUtils {
	
<span class="fc" id="L45">	private static  Logger logger = LogManager.getLogger(PullUtils.class);</span>

<span class="nc" id="L47">	private PullUtils() {</span>
<span class="nc" id="L48">		throw new IllegalStateException(&quot;Utility class&quot;);</span>
	}

	/**
	 * @param pullURL
	 * @param fileName
	 * @param filePath
	 * @param loadProperties
	 * @return headerFields
	 * @throws JSONException 
	 * @throws SQLException 
	 */
	public static Map&lt;String, Object&gt; pullMethod(String pullURL,
			String fileName, String filePath) throws JSONException, SQLException {
<span class="fc" id="L62">		Map&lt;String, List&lt;String&gt;&gt; headerFields = new HashMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="fc" id="L63">		Map&lt;String, Object&gt; returnMap = new HashMap&lt;String, Object&gt;();</span>
		//logger.debug(&quot;File storage path.......&quot; + filePath);
		//logger.debug(&quot;Downloaded file name.......&quot; + fileName);

<span class="fc" id="L67">		logger.debug(&quot;Start Time for the pullMethod process :::&quot; + new Date().toString());</span>
		
		java.net.URL url;
<span class="fc" id="L70">		FileOutputStream fos = null;</span>

		try {
<span class="fc" id="L73">			String sbearerToken = AzureTokenService.getswgwAuthenticate();</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">			if(StringUtils.isOnlyWhitespaceOrEmpty(sbearerToken)){</span>
				//logger.error(&quot;bearer token is empty cant initate pull service towards SW Gateway&quot;);
<span class="nc" id="L76">				return returnMap;</span>
			}
<span class="fc" id="L78">			String auth = String.format(Constants.BEARER, sbearerToken);</span>
<span class="fc" id="L79">			url = new java.net.URL(pullURL);</span>
<span class="fc" id="L80">			HttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();</span>
<span class="fc" id="L81">			httpURLConnection.setReadTimeout(600000);</span>
<span class="fc" id="L82">			httpURLConnection.setConnectTimeout(600000);</span>
<span class="fc" id="L83">			httpURLConnection.setRequestMethod(&quot;GET&quot;);</span>
<span class="fc" id="L84">			httpURLConnection.setRequestProperty(HttpHeaders.AUTHORIZATION, auth);</span>
			//httpURLConnection.setRequestProperty(HttpHeaders.PRAGMA, Constants.PRAGMA_HEADER_KEY_VALUE);
<span class="fc" id="L86">			httpURLConnection.setRequestProperty(HttpHeaders.USER_AGENT, Constants.APPLICATION);</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">			 if (httpURLConnection.getResponseCode() == HttpURLConnection.HTTP_OK) {</span>
<span class="fc" id="L88">				 InputStream in = new BufferedInputStream(httpURLConnection.getInputStream());</span>
<span class="fc" id="L89">				 headerFields = httpURLConnection.getHeaderFields();</span>
<span class="pc bpc" id="L90" title="1 of 4 branches missed.">					if(fileName.contains(&quot;SMO&quot;) || fileName.contains(&quot;NMS&quot;)){</span>
<span class="fc" id="L91">						fileName = getFileNameFromResponse(headerFields);</span>
					}			
<span class="fc" id="L93">					java.io.File file = new java.io.File(filePath + Constants.BACK_SLASH+ fileName);</span>
<span class="fc" id="L94">					System.out.println(&quot;file::::&quot;+file.getAbsolutePath());</span>
					
<span class="fc" id="L96">					fos = new FileOutputStream(file);</span>
<span class="fc" id="L97">					byte[] buf = new byte[1024];</span>
<span class="fc" id="L98">					int n = 0;</span>
<span class="fc" id="L99">					int byteCount = 0;</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">					while (-1 != (n = in.read(buf))) {</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">						if (byteCount == 2048) {</span>
<span class="nc" id="L102">							byteCount = 0;</span>
						}
<span class="fc" id="L104">						byteCount++;</span>
<span class="fc" id="L105">						fos.write(buf, 0, n);</span>
					}
<span class="fc" id="L107">					in.close();</span>
				
<span class="fc" id="L109">				returnMap.put(&quot;file&quot;, file);</span>
<span class="fc" id="L110">				returnMap.put(&quot;fileName&quot;, fileName);</span>
<span class="fc" id="L111">				returnMap.put(&quot;headerFields&quot;, headerFields);</span>
<span class="fc" id="L112">			 }else{</span>
<span class="nc" id="L113">				 InputStream errorStream = httpURLConnection.getErrorStream();</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">			        if (errorStream != null) {</span>
<span class="nc" id="L115">			            BufferedReader reader = new BufferedReader(new InputStreamReader(errorStream));</span>
			            String line;
<span class="nc bnc" id="L117" title="All 2 branches missed.">			            while ((line = reader.readLine()) != null) {</span>
<span class="nc" id="L118">			            	logger.error(&quot;Unable to download packages from SW Gateway::::&quot; + &quot;Server returned HTTP &quot; + httpURLConnection.getResponseCode()</span>
<span class="nc" id="L119">							        + &quot; &quot; + httpURLConnection.getResponseMessage()+line);</span>
			            }
			           
<span class="nc" id="L122">			            reader.close();</span>
<span class="nc" id="L123">			            errorStream.close();</span>
			        }
<span class="nc" id="L125">			        return returnMap;  </span>
			    }
<span class="nc" id="L127">		} catch (IOException e) {</span>
<span class="nc" id="L128">			logger.error(&quot;Unable to download packages from SW Gateway::::&quot;+e.getMessage());</span>
<span class="nc" id="L129">			e.printStackTrace();</span>
		} finally {
			try {
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">				if (null != fos) {</span>
<span class="fc" id="L133">					fos.close();</span>
				}
<span class="nc" id="L135">			} catch (IOException e) {</span>
<span class="nc" id="L136">				e.printStackTrace();</span>
<span class="fc" id="L137">			}</span>
		}
		//System.out.println(&quot;headerFields:::::::::::::&quot;+headerFields);
<span class="fc" id="L140">		System.out.println(&quot;END Time for the pullMethod process :::&quot; + new Date().toString());</span>
<span class="fc" id="L141">		return returnMap;</span>

	}

	/**
	 * @param fileName
	 * @param headerFields
	 * @return
	 */
	private static String getFileNameFromResponse(Map&lt;String, List&lt;String&gt;&gt; headerFields) {
<span class="fc" id="L151">		String fileName = &quot;&quot;;</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">		if(headerFields.containsKey(&quot;fileName&quot;)){</span>
<span class="fc" id="L153">			StringBuilder sbfileName = new StringBuilder(headerFields.get(&quot;fileName&quot;).toString());</span>
<span class="fc" id="L154">			sbfileName.deleteCharAt(sbfileName.length() - 1);</span>
<span class="fc" id="L155">			sbfileName.deleteCharAt(0);</span>
<span class="fc" id="L156">			fileName = sbfileName.toString();</span>
<span class="fc" id="L157">			fileName = fileName.replace(&quot;/&quot;, &quot;_&quot;).replaceAll(&quot;\\s&quot;, &quot;&quot;);</span>
		}
<span class="fc" id="L159">		return fileName;</span>
	}

	/**
	 * @param trustAnchorFileUrl
	 * @param fileName
	 * @param currentDirectory
	 * @throws IOException
	 */
	public static void pullAnchorFile(String trustAnchorFileUrl,
			String fileName, String currentDirectory) throws IOException {
<span class="fc" id="L170">		java.io.File file = new java.io.File(currentDirectory</span>
				+ Constants.BACK_SLASH + fileName);
		java.net.URL url;
<span class="fc" id="L173">		FileOutputStream fos = null;</span>
		try {
<span class="fc" id="L175">			url = new java.net.URL(trustAnchorFileUrl);</span>
<span class="fc" id="L176">			URLConnection openConnection = url.openConnection();</span>
<span class="fc" id="L177">			openConnection.setReadTimeout(600000);</span>
<span class="fc" id="L178">			openConnection.setConnectTimeout(600000);</span>
<span class="fc" id="L179">			InputStream in = new BufferedInputStream(</span>
<span class="fc" id="L180">					openConnection.getInputStream());</span>
<span class="fc" id="L181">			fos = new FileOutputStream(file);</span>
<span class="fc" id="L182">			byte[] buf = new byte[1024];</span>
<span class="fc" id="L183">			int n = 0;</span>
<span class="fc" id="L184">			int byteCount = 0;</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">			while (-1 != (n = in.read(buf))) {</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">				if (byteCount == 2048) {</span>
<span class="nc" id="L187">					byteCount = 0;</span>
				}
<span class="fc" id="L189">				byteCount++;</span>
<span class="fc" id="L190">				fos.write(buf, 0, n);</span>
			}
<span class="fc" id="L192">			in.close();</span>

<span class="nc" id="L194">		} catch (IOException e) {</span>
<span class="nc" id="L195">			e.printStackTrace();</span>
		} finally {
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">			if (null != fos) {</span>
<span class="fc" id="L198">				fos.close();</span>
			}
		}

<span class="fc" id="L202">	}	</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>