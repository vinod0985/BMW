<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TriggerDownloadNotification.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">eric-swgwda</a> &gt; <a href="index.source.html" class="el_package">com.ericsson.swgw.da.actions</a> &gt; <span class="el_source">TriggerDownloadNotification.java</span></div><h1>TriggerDownloadNotification.java</h1><pre class="source lang-java linenums">package com.ericsson.swgw.da.actions;

/*###################################################################################
 #  @Name           :   TriggerDownloadNotification.java
 #
 #  @Created        :   Sep Drop 2022
 #
 #  @Description    :   To generated access token and pull sw packages from SW Gateway
 #
 #  @Programmer     :   Eswar D
 #
 #  @Organization   :   HCL
 #
 #  @Release        :   MR2209
 #
 #  @History        :
 #      Xsignum/Esignum :   Date(DD-MM-YYYY)    :   description
 #      ZDARESW(Eswar)      29-Aug-2022            Download action
 ######################################################################################*/

import io.minio.errors.MinioException;
import java.io.File;
import java.io.IOException;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import javax.xml.bind.JAXBException;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.codehaus.jettison.json.JSONException;
import com.ericsson.swgw.da.bean.Checksum;
import com.ericsson.swgw.da.bean.DMSBean;
import com.ericsson.swgw.da.bean.Products;
import com.ericsson.swgw.da.bean.Webhook;
import com.ericsson.swgw.da.constants.Constants;
import com.ericsson.swgw.da.dms.DMSService;
import com.ericsson.swgw.da.exception.CustomException;
import com.ericsson.swgw.da.exception.SignatureValidationException;
import com.ericsson.swgw.da.filter.ProductFilter;
import com.ericsson.swgw.da.model.Referencedocument;
import com.ericsson.swgw.da.properties.IniConfig;
import com.ericsson.swgw.da.services.AzureTokenService;
import com.ericsson.swgw.da.services.PullProductService;
import com.ericsson.swgw.da.services.PullTicketXMLService;
import com.ericsson.swgw.da.services.Referencedocurls;
import com.ericsson.swgw.da.swgw.bean.SWGReferenceDocs;
import com.ericsson.swgw.da.swgw.bean.SWGReferenceDocs.ENMDocuments.ENMDocument;
import com.ericsson.swgw.da.swgw.bean.SWGReferenceDocs.ReleaseDocs.ReleaseDoc;
import com.ericsson.swgw.da.swgw.bean.TicketXMLGenerator;
import com.ericsson.swgw.da.utils.ChecksumUtils;
import com.ericsson.swgw.da.utils.FileUtils;
import com.ericsson.swgw.da.utils.PullUtils;
import com.ericsson.swgw.da.utils.StringUtils;
import com.ericsson.swgw.da.validations.ChecksumValidation;
import com.ericsson.swgw.da.validations.SignatureValidation;
import com.jcraft.jsch.JSchException;

public class TriggerDownloadNotification {

	private static final String HEADER_FIELDS = &quot;headerFields&quot;;
	private static final String FILE = &quot;file&quot;;
<span class="fc" id="L65">	private static  Logger logger = LogManager.getLogger(TriggerDownloadNotification.class);</span>
	private static final String JSONFIELD_SHA256 = &quot;sha256&quot;;
	private static final String JSONFIELD_MD5 = &quot;md5&quot;;
<span class="fc" id="L68">	private static final String currentDirectory = System.getProperty(Constants.USER_DIR);</span>


<span class="nc" id="L71">	public TriggerDownloadNotification() {</span>
<span class="nc" id="L72">		throw new IllegalStateException(&quot;Action class&quot;);</span>
	}


	/**
	 * @param lWebhook
	 *            Received payload stored into beans
	 * @param ldProperties
	 *            to load properties from property file
	 * @throws SignatureValidationException 
	 * @throws CustomException 
	 * @throws JSONException 
	 * @throws IOException 
	 * @throws SQLException 
	 * @throws JAXBException 
	 * @throws JSchException 
	 * @throws MinioException 
	 * @throws Exception 
	 */
	@SuppressWarnings({ &quot;unused&quot;, &quot;unchecked&quot; })
	public static void swgwTriggerServices(Webhook webhook) throws SignatureValidationException, CustomException, JSONException, IOException, SQLException, JAXBException, MinioException, JSchException {
		try {
			
<span class="fc" id="L95">			List&lt;String&gt; productBoxNames = webhook.getWHProductNames(webhook);</span>
						
<span class="fc" id="L97">			logger.info(&quot;Start DA Pckage products Filter&quot;);</span>
<span class="fc" id="L98">			List&lt;String&gt; productsFilterList = ProductFilter.getproductsFilterList();</span>
<span class="fc" id="L99">			logger.info(&quot;productsFilterList&quot; +productsFilterList);</span>
<span class="fc" id="L100">			logger.info(&quot;END DA Pckage products Filter&quot;);</span>
			
<span class="fc" id="L102">			Boolean isDownloadEntireTicket = false;</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">			if(Boolean.TRUE.equals(ProductFilter.isDownloadEntireTicket())){</span>
<span class="nc" id="L104">				List&lt;String&gt; collectProducts = productsFilterList.stream()</span>
<span class="nc" id="L105">                   .filter(productBoxNames::contains)</span>
<span class="nc" id="L106">                   .collect(Collectors</span>
<span class="nc" id="L107">                                .toList());</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">				if(collectProducts.isEmpty()){</span>
<span class="nc" id="L109">					throw new CustomException(&quot;Download Entire Ticket is enabled and Product Filter didn't matched&quot; );</span>
				}
			}			
			
<span class="fc" id="L113">			logger.info(&quot;Start DA Pckage Download Flow&quot;);</span>
<span class="fc" id="L114">			String bearerToken = AzureTokenService.getswgwAuthenticate();</span>
			
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">			if (!StringUtils.isOnlyWhitespaceOrEmpty(bearerToken)) {</span>
<span class="fc" id="L117">				logger.info(&quot;Bearer token generated. Hence,proceeding further..... &quot;);</span>
<span class="fc" id="L118">				PullTicketXMLService pullTicketXMLService = new PullTicketXMLService(webhook);</span>
<span class="fc" id="L119">				PullProductService pullProductService = new PullProductService(webhook);</span>
<span class="fc" id="L120">				Referencedocurls referencedocurls = new Referencedocurls(webhook) ;</span>
<span class="fc" id="L121">				Referencedocument referencedocument = new Referencedocument(webhook);</span>
<span class="fc" id="L122">				String downloadDir = IniConfig.getSwgwDownloadDir();</span>
<span class="fc" id="L123">				String apiUrl = IniConfig.getSwgwApiURL();</span>
<span class="fc" id="L124">				String logsPath = currentDirectory + Constants.BACK_SLASH + &quot;logs&quot;;</span>

				// download ticket-XML in temp path
<span class="fc" id="L127">				String ticketXmlFileName = webhook.getTicket() + Constants.XML_EXT;</span>
<span class="fc" id="L128">				java.io.File ticketXmlFile =  null;</span>
<span class="fc" id="L129">				Map&lt;String, List&lt;String&gt;&gt; responseHeadersTicket =  null;</span>
<span class="fc" id="L130">				List&lt;Products&gt; products = webhook.getProducts();</span>
<span class="fc" id="L131">				String pullTicketxmlUrL = pullTicketXMLService.getPullTicketxmlURL(apiUrl);</span>
<span class="fc" id="L132">				logger.debug(&quot;pullTicketxmlUrL ::::&quot;+pullTicketxmlUrL);</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">				if (!StringUtils.isOnlyWhitespaceOrEmpty(pullTicketxmlUrL)) {</span>
<span class="fc" id="L134">					Map&lt;?, ?&gt; returnMapTicket = pullTicketXMLService.pullTicketxml( logsPath, ticketXmlFileName, pullTicketxmlUrL);</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">					if(returnMapTicket.containsKey(HEADER_FIELDS)){</span>
<span class="fc" id="L136">						responseHeadersTicket = ((Map&lt;String, List&lt;String&gt;&gt;) returnMapTicket.get(HEADER_FIELDS));</span>
					}
					
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">					if(returnMapTicket.containsKey(FILE)){</span>
<span class="fc" id="L140">						ticketXmlFile = (File) returnMapTicket.get(FILE);</span>
<span class="fc" id="L141">						System.out.println(&quot;pullTicketxml getAbsolutePath() ::::&quot;+ticketXmlFile.getAbsolutePath());</span>
					}
					
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">					if(ticketXmlFile != null){</span>
<span class="fc" id="L145">						String ticketXmlChecksumMissMatch = checksumValidationTicketXMl(ticketXmlFile, responseHeadersTicket);</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">						if(!StringUtils.isOnlyWhitespaceOrEmpty(ticketXmlChecksumMissMatch)){</span>
<span class="nc" id="L147">							ticketXmlFile.delete();</span>
<span class="nc" id="L148">							logger.error(&quot;Checksum Mismatched for &quot; + ticketXmlFile + &quot; due to &quot;</span>
										+ ticketXmlChecksumMissMatch);
<span class="nc" id="L150">							ChecksumValidation.raiseChecksumException(ticketXmlFile, ticketXmlChecksumMissMatch);</span>
							
							}else{
<span class="fc" id="L153">							logger.info(&quot;Checksum Validation success for ticket-xml after downloading into temp &quot;+ ticketXmlFile.getAbsolutePath());</span>
<span class="fc" id="L154">							TicketXMLGenerator  ticketXML = PullTicketXMLService.getTicketXMLGenerator(ticketXmlFile);</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">							if(ticketXML != null){</span>
<span class="fc" id="L156">							com.ericsson.swgw.da.swgw.bean.TicketXMLGenerator.Boxes boxes = ticketXML.getBoxes();</span>
<span class="fc" id="L157">							List&lt;TicketXMLGenerator.Boxes.Box&gt; box = boxes.getBox();</span>
<span class="fc" id="L158">			 			    List&lt;String&gt; productBoxes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L159">							List&lt;String&gt; successProductBoxes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L160">							List&lt;String&gt; failedProductBoxes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L161">							List&lt;java.io.File&gt; successFiles = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L162">							List&lt;java.io.File&gt; failureFiles = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L163">							List&lt;java.io.File&gt; successTransferedFiles = new ArrayList&lt;&gt;();</span>
							
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">							for (com.ericsson.swgw.da.swgw.bean.TicketXMLGenerator.Boxes.Box eachBox : box) {</span>
<span class="fc" id="L166">								String productNumber = eachBox.getProductNumber();							</span>
<span class="pc bpc" id="L167" title="5 of 6 branches missed.">								if((ProductFilter.isVerifyProducts() &amp;&amp; !ProductFilter.isDownloadEntireTicket()) &amp;&amp; !productsFilterList.contains(productNumber)){</span>
<span class="nc" id="L168">									continue;</span>
								} 
								
<span class="fc" id="L171">								String productVersion = eachBox.getVersion();</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">								if(StringUtils.isOnlyWhitespaceOrEmpty(productVersion)){</span>
<span class="fc" id="L173">									productVersion = eachBox.getRState();</span>
								}
<span class="fc" id="L175">								productBoxes.add(productNumber+ &quot;-&quot;+productVersion);</span>
<span class="fc" id="L176">								logger.info(&quot;Begin of processing the product.......&quot;+productNumber+ &quot;-&quot;+productVersion);</span>
								
<span class="fc" id="L178">								SWGReferenceDocs refDocXML =  referencedocurls.getRefdocurls(apiUrl, productNumber, productVersion);</span>
<span class="fc" id="L179">								logger.debug(&quot;refDocXML::::::::::::::::&quot;+refDocXML);</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">								if(refDocXML == null){</span>
<span class="nc" id="L181">									failedProductBoxes.add(productNumber+ &quot;-&quot;+productVersion);</span>
<span class="nc" id="L182">									break;</span>
								}
								//ReleaseDocs  releaseDocs =   Referencedocument.getReleaseDocsBean(refDocXML);
<span class="fc" id="L185">								ReleaseDoc  signatureFile =   Referencedocument.getSignatureFileBean(refDocXML);</span>
<span class="fc" id="L186">								logger.debug(&quot;signatureFile::::::::::::::::&quot;+signatureFile);</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">								if(signatureFile == null){</span>
<span class="nc" id="L188">									failedProductBoxes.add(productNumber+ &quot;-&quot;+productVersion);</span>
<span class="nc" id="L189">									break;</span>
								}
								
<span class="fc" id="L192">								ReleaseDoc  manifestFileBean =   Referencedocument.getManifestFileBean(refDocXML);</span>
<span class="fc" id="L193">								logger.debug(&quot;manifestFile::::::::::::::::&quot;+manifestFileBean);</span>
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">								if(manifestFileBean == null){</span>
<span class="nc" id="L195">									failedProductBoxes.add(productNumber+ &quot;-&quot;+productVersion);</span>
<span class="nc" id="L196">									break;</span>
								}
<span class="fc" id="L198">								logger.debug(&quot;downloadDir:::::::::&quot;+downloadDir);</span>
<span class="fc" id="L199">								File manifestFile = Referencedocument.getManifestFile(manifestFileBean,downloadDir);</span>
<span class="fc" id="L200">								logger.debug(&quot;manifestFile:::::::::&quot;+manifestFile.getAbsolutePath());</span>
<span class="fc" id="L201">								File signFile = Referencedocument.getsignatureFile(signatureFile,downloadDir);</span>
<span class="fc" id="L202">								logger.debug(&quot;signFile:::::::::&quot;+signFile.getAbsolutePath());</span>
<span class="fc" id="L203">								boolean isSignsuccess = false;</span>
<span class="pc bpc" id="L204" title="2 of 4 branches missed.">								if(signFile.exists() &amp;&amp; manifestFile.exists()){</span>
<span class="fc" id="L205">									isSignsuccess = SignatureValidation.boxSignatureValidation(signFile.getAbsolutePath(),manifestFile.getAbsolutePath());</span>
								}else {
<span class="nc" id="L207">									failedProductBoxes.add(productNumber+ &quot;-&quot;+productVersion);</span>
<span class="nc" id="L208">									break;</span>
									//logger.error(&quot;signature File Not found in the temporary location ::&quot; + signFile.getAbsolutePath );
								}				
								
								/*Success :: Continue Flow. 
								 *Failed ::  Delete the files (sign file, all Box files for this tickets xml) and
								 *			 stop the flow
								*/
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">								if(isSignsuccess){</span>
<span class="fc" id="L217">									logger.info(&quot;Signature Validation Success&quot;);</span>
<span class="fc" id="L218">									successFiles.add(signFile);</span>
<span class="fc" id="L219">									successFiles.add(manifestFile);</span>
<span class="fc" id="L220">									java.io.File pullBoxFile = null;</span>
<span class="fc" id="L221">									String checksumMissMatch = &quot;&quot;;</span>
<span class="fc" id="L222">									Map&lt;?, ?&gt; returnMap = pullProductService.pullProduct(downloadDir, productNumber, productVersion);</span>
<span class="fc" id="L223">									Map&lt;String, List&lt;String&gt;&gt; responseHeaders =  new HashMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">									if(returnMap.containsKey(HEADER_FIELDS)){</span>
<span class="fc" id="L225">										responseHeaders = ((Map&lt;String, List&lt;String&gt;&gt;) returnMap.get(HEADER_FIELDS));</span>
									}
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">									if(returnMap.containsKey(FILE)){</span>
<span class="fc" id="L228">										pullBoxFile = (File) returnMap.get(FILE);</span>
									}
									
<span class="fc" id="L231">									Checksum payloadChecksum = null;</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">									for(Products product:products){</span>
<span class="pc bpc" id="L233" title="1 of 4 branches missed.">										if(productNumber.equalsIgnoreCase(product.getNumber()) &amp;&amp; productVersion.equalsIgnoreCase(product.getVersion())){</span>
<span class="fc" id="L234">											payloadChecksum = product.getChecksum();</span>
<span class="fc" id="L235">											break;</span>
										}									
<span class="fc" id="L237">									}</span>
<span class="fc" id="L238">									org.codehaus.jettison.json.JSONObject json = new org.codehaus.jettison.json.JSONObject();</span>
<span class="fc" id="L239">									String ticketxmlSHA256 = eachBox.getSHA256();</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">									if (!StringUtils.isOnlyWhitespaceOrEmpty(ticketxmlSHA256)) {</span>
<span class="fc" id="L241">										json.put(JSONFIELD_SHA256, ticketxmlSHA256);</span>
									}
<span class="fc" id="L243">									String ticketxmlMD5 = eachBox.getMD5();</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">									if (!StringUtils.isOnlyWhitespaceOrEmpty(ticketxmlMD5)) {</span>
<span class="fc" id="L245">										json.put(JSONFIELD_MD5, ticketxmlMD5);</span>
									}	
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">									if(null != pullBoxFile){</span>
<span class="fc" id="L248">										checksumMissMatch = ChecksumValidation.parseChecksum(responseHeaders, pullBoxFile,payloadChecksum,json);</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">										if (!StringUtils.isOnlyWhitespaceOrEmpty(checksumMissMatch)) {</span>
<span class="fc" id="L250">											failureFiles.add(pullBoxFile);</span>
<span class="fc" id="L251">											failureFiles.add(signFile);</span>
<span class="fc" id="L252">											failureFiles.add(manifestFile);</span>
<span class="fc" id="L253">											failedProductBoxes.add(productNumber+ &quot;-&quot;+productVersion);</span>
<span class="fc" id="L254">											break;</span>
										} else {
<span class="fc" id="L256">											logger.info(&quot;Checksum Validation Success for &quot;+pullBoxFile);</span>
<span class="fc" id="L257">											successProductBoxes.add(productNumber+ &quot;-&quot;+productVersion);</span>
<span class="fc" id="L258">											successFiles.add(pullBoxFile);</span>
<span class="fc" id="L259">											successFiles.add(signFile);</span>
<span class="fc" id="L260">											successFiles.add(manifestFile);</span>
											//Download SMO/NMS Files for each box
<span class="fc" id="L262">											List&lt;ENMDocument&gt;   enmDocumentList =   Referencedocument.getENMDocuments(refDocXML);</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">											if(enmDocumentList != null){</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">												for (ENMDocument enmDocument : enmDocumentList) {</span>
<span class="fc" id="L265">													File fENMDocument = Referencedocument.getENMDocumentFile(enmDocument,downloadDir);</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">													if(fENMDocument.exists()){</span>
<span class="fc" id="L267">														successFiles.add(fENMDocument);</span>
														//logger.debug(&quot;SMO/NMO Document  File  found in the  location ::&quot; + fENMDocument.getAbsolutePath );
													} else {
<span class="nc" id="L270">														failureFiles.add(fENMDocument);</span>
														//logger.error(&quot;SMO/NMO Document  File Not found in the  location ::&quot; + fENMDocument.getAbsolutePath );
													}
													
<span class="fc" id="L274">												}</span>
												
											}	
<span class="fc" id="L277">											logger.info(&quot;SMO/NMS  Files Completed&quot;);</span>
<span class="fc" id="L278">										}</span>
									}else{
<span class="nc" id="L280">										failureFiles.add(signFile);</span>
<span class="nc" id="L281">										failureFiles.add(manifestFile);</span>
<span class="nc" id="L282">										failedProductBoxes.add(productNumber+ &quot;-&quot;+productVersion);</span>
<span class="nc" id="L283">										logger.error(&quot;The download of product failed for&quot;+productNumber+ &quot;-&quot;+productVersion);</span>
									}
<span class="fc" id="L285">								} else {</span>
<span class="nc" id="L286">									logger.error(&quot;Signature Validation Failed for Sign File:: &quot;+signFile + &quot;&amp;&amp; Manifest File :: &quot;+manifestFile);</span>
<span class="nc" id="L287">									failureFiles.add(signFile);</span>
<span class="nc" id="L288">									failureFiles.add(manifestFile);</span>
<span class="nc" id="L289">									failedProductBoxes.add(productNumber+ &quot;-&quot;+productVersion);</span>
<span class="nc" id="L290">									break;</span>
								}
<span class="fc" id="L292">								logger.info(&quot;End of processing the product.......&quot;+productNumber+ &quot;-&quot;+productVersion);</span>
<span class="fc" id="L293">							}</span>
							
							//Move Ticket XML from Temp location in to Local Storage
<span class="fc" id="L296">							logger.debug(&quot;productBoxes:::::&quot;+productBoxes);</span>
<span class="fc" id="L297">							logger.debug(&quot;successProductBoxes:::::&quot;+successProductBoxes);</span>
<span class="fc" id="L298">							logger.debug(&quot;failedProductBoxes:::::&quot;+failedProductBoxes);</span>
<span class="pc bpc" id="L299" title="4 of 6 branches missed.">							if(productBoxes.size() &gt; 0 &amp;&amp; (productBoxes.size() == successProductBoxes.size())&amp;&amp; failureFiles.size()== 0){</span>
<span class="nc" id="L300">								logger.info(&quot;All Box Validations are success&quot;);</span>
<span class="nc" id="L301">								File ticketXmlManifestFile = getTicketXmlManifestFile(responseHeadersTicket,ticketXmlFileName,downloadDir);</span>
<span class="nc" id="L302">								successFiles.add(ticketXmlManifestFile);</span>
<span class="nc" id="L303">								boolean isMoved = FileUtils.moveFileToDestination(logsPath,downloadDir,ticketXmlFileName);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">								if(isMoved) {</span>
<span class="nc" id="L305">									File movedTicketXml = new File(downloadDir,ticketXmlFileName);</span>
<span class="nc" id="L306">									String mvXmlChecksumMismatch = checksumValidationTicketXMl(movedTicketXml,responseHeadersTicket);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">									if(!StringUtils.isOnlyWhitespaceOrEmpty(mvXmlChecksumMismatch)){</span>
<span class="nc" id="L308">										movedTicketXml.delete();</span>
<span class="nc" id="L309">										logger.error(&quot;Checksum Mismatched for &quot; + movedTicketXml + &quot; due to &quot;</span>
													+ mvXmlChecksumMismatch);
<span class="nc" id="L311">										ChecksumValidation.raiseChecksumException(movedTicketXml, mvXmlChecksumMismatch);</span>
									}else{
<span class="nc" id="L313">										logger.info(&quot;Checksum Validation success for ticket-xml after moving into DA Store&quot;+ movedTicketXml.getAbsolutePath());</span>
<span class="nc" id="L314">									successFiles.add(movedTicketXml);</span>
									//FileUtils.deleteFile(logsPath,ticketXmlFileName);
									}
<span class="nc" id="L317">								} else {</span>
<span class="nc" id="L318">									logger.error(&quot;unable to move file from source to Destination ::&quot; + logsPath,downloadDir,ticketXmlFileName);</span>
								}
<span class="nc bnc" id="L320" title="All 2 branches missed.">								if(FileTransfer.isDownloadOnly()){</span>
<span class="nc" id="L321">									logger.info(&quot;Begin of file transfer.........&quot;);</span>
<span class="nc" id="L322">									successTransferedFiles = FileTransfer.transferFiles(successFiles);</span>
<span class="nc" id="L323">	                                logger.info(&quot;End of file transfer.........&quot;);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">	                                for(File transferedFile : successTransferedFiles ){</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">										if (transferedFile.exists()){</span>
<span class="nc" id="L326">											transferedFile.delete();</span>
										}
<span class="nc" id="L328">										logger.info(&quot;Cleaning the local DA Store after sucessfull File Transfer&quot;);</span>
<span class="nc" id="L329">									}</span>
	                            }
								
<span class="nc bnc" id="L332" title="All 2 branches missed.">								if(!StringUtils.isOnlyWhitespaceOrEmpty(IniConfig.getDMSURL())){</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">									for (com.ericsson.swgw.da.swgw.bean.TicketXMLGenerator.Boxes.Box eachBox : box) {</span>
<span class="nc" id="L334">										logger.info(&quot;Triggreing DMS for the product &quot;+ eachBox.getProductNumber());</span>
<span class="nc" id="L335">										String productNumber = eachBox.getProductNumber().replace(&quot;/&quot;, &quot;_&quot;).replaceAll(&quot;\\s&quot;, &quot;&quot;);</span>
<span class="nc" id="L336">										DMSBean dmsBean = DMSBean.prepareDMSBean(webhook, eachBox.getProductNumber());							</span>
<span class="nc" id="L337">										int dmsStatusCode = DMSService.sendDMSNotification(dmsBean,eachBox.getProductNumber());</span>
<span class="nc" id="L338">										logger.info(&quot;DMS Status Code&quot;+dmsStatusCode);</span>
<span class="nc" id="L339">									}</span>
								}
								
								
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">							} else if (!ProductFilter.isVerifyProducts()){</span>

								//XML file delete
								//FileUtils.deleteFile(logsPath,ticketXmlFileName);
								
								//cleaning success Boxes with Sig &amp; Manifest Files and SMO &amp; NMO Files if any Box Checksum validation fails 
<span class="fc bfc" id="L349" title="All 2 branches covered.">									for(File successList : successFiles ){</span>
<span class="pc bpc" id="L350" title="1 of 4 branches missed.">										if (null != successList &amp;&amp; successList.exists()){</span>
<span class="fc" id="L351">											logger.info(&quot;successFiles::::&quot;+successList.getName());</span>
<span class="fc" id="L352">											successList.delete();</span>
										}
<span class="fc" id="L354">									}</span>
								
								
								//cleaning Sig &amp; Manifest Files and SMO &amp; NMO Files
<span class="fc bfc" id="L358" title="All 2 branches covered.">									for(File failureList : failureFiles ){</span>
<span class="pc bpc" id="L359" title="2 of 4 branches missed.">										if (null != failureList &amp;&amp; failureList.exists()){</span>
<span class="nc" id="L360">											logger.info(&quot;failureFiles::::&quot;+failureList.getName());</span>
<span class="nc" id="L361">											failureList.delete();</span>
										}
<span class="fc" id="L363">									}</span>
								
							}else {
								//XML file delete
								//FileUtils.deleteFile(logsPath,ticketXmlFileName);
								
								//cleaning success Boxes with Sig &amp; Manifest Files and SMO &amp; NMO Files if any Box Checksum validation fails 
<span class="nc bnc" id="L370" title="All 2 branches missed.">								for(File successList : successFiles ){</span>
<span class="nc bnc" id="L371" title="All 4 branches missed.">									if (null != successList &amp;&amp; successList.exists()){</span>
<span class="nc" id="L372">										logger.info(&quot;successFiles::::&quot;+successList.getName());</span>
<span class="nc" id="L373">										successList.delete();</span>
									}
<span class="nc" id="L375">								}</span>
							
							
							//cleaning Sig &amp; Manifest Files and SMO &amp; NMO Files
<span class="nc bnc" id="L379" title="All 2 branches missed.">								for(File failureList : failureFiles ){</span>
<span class="nc bnc" id="L380" title="All 4 branches missed.">									if (null != failureList &amp;&amp; failureList.exists()){</span>
<span class="nc" id="L381">										logger.info(&quot;failureFiles::::&quot;+failureList.getName());</span>
<span class="nc" id="L382">										failureList.delete();</span>
									}
<span class="nc" id="L384">								}</span>
							}
							
						
<span class="fc" id="L388">						} else {</span>
<span class="nc" id="L389">							logger.error(&quot;Ticket XML Not found ::&quot; + logsPath + Constants.BACK_SLASH + ticketXmlFileName );</span>
							//FileUtils.deleteFile(logsPath,ticketXmlFileName);
						}
					  }
<span class="fc" id="L393">					}else{</span>
<span class="nc" id="L394">						logger.error(&quot;The download of ticket-xml failed. Hence,can't proceed further&quot;);</span>
					}
					
					 
<span class="fc" id="L398">				}else {</span>
<span class="nc" id="L399">					logger.error(&quot;pullTicketxmlUrL is Empty. ::&quot; + pullTicketxmlUrL);</span>
				}
<span class="fc" id="L401">			}else{</span>
<span class="nc" id="L402">				logger.error(&quot;Bearer token failed to generated or it is empty::&quot; +bearerToken );</span>
			}
<span class="fc" id="L404">     		logger.info(&quot;End Of DA Download Flow&quot;);</span>
<span class="nc" id="L405">		} catch (IOException e) {</span>
<span class="nc" id="L406">			e.printStackTrace();</span>
<span class="nc" id="L407">			throw new IOException(e.getMessage());</span>
		} /*catch (JAXBException e1) {
			e1.printStackTrace();
			throw new JAXBException(e1.getMessage());
<span class="nc" id="L411">		}*/ catch (JSONException e2) {</span>
<span class="nc" id="L412">			e2.printStackTrace();</span>
<span class="nc" id="L413">			throw new JSONException(e2.getMessage());</span>
<span class="fc" id="L414">		}</span>
<span class="fc" id="L415">	}</span>


	private static String checksumValidationTicketXMl(java.io.File ticketXmlFile,
			Map&lt;String, List&lt;String&gt;&gt; responseHeadersTicket) {
<span class="fc" id="L420">		String sha256 = ChecksumUtils.calculateChecksum(</span>
					ticketXmlFile, Constants.CHECKSUM_SHA256);
<span class="fc" id="L422">		System.out.println(&quot;calculated sha256 for ticket-xml :: &quot;+sha256);</span>
<span class="fc" id="L423">		String md5 = ChecksumUtils.calculateChecksum(</span>
					ticketXmlFile, Constants.CHECKSUM_MD5);
<span class="fc" id="L425">		System.out.println(&quot;calculated md5 for ticket-xml :: &quot;+md5);</span>
<span class="fc" id="L426">		String ticketXmlChecksumMissMatch = ChecksumValidation</span>
<span class="fc" id="L427">					.validateTicketXmlChecksumWithResHeader(sha256, md5,responseHeadersTicket);</span>
<span class="fc" id="L428">		return ticketXmlChecksumMissMatch;</span>
	}


	private static File getTicketXmlManifestFile(
			Map&lt;String, List&lt;String&gt;&gt; responseHeadersTicket, String ticketXmlFileName, String downloadDir) throws JSONException, SQLException {
<span class="nc" id="L434">		java.io.File file =  null;</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">		if(responseHeadersTicket.containsKey(Constants.MANIFEST_SHA256)){</span>
<span class="nc" id="L436">			StringBuilder xmlSHA256 = new StringBuilder(responseHeadersTicket.get(Constants.MANIFEST_SHA256).toString());</span>
<span class="nc" id="L437">			xmlSHA256.deleteCharAt(xmlSHA256.length() - 1);</span>
<span class="nc" id="L438">			xmlSHA256.deleteCharAt(0);</span>
<span class="nc" id="L439">			String headerXmlSHA256Url= xmlSHA256.toString();</span>
<span class="nc" id="L440">			logger.info(&quot;Ticket-XML MANIFEST_SHA256 Url .... &quot;+headerXmlSHA256Url);</span>
<span class="nc" id="L441">			StringBuilder txmlSB = new StringBuilder();</span>
<span class="nc" id="L442">			txmlSB.append(ticketXmlFileName);</span>
<span class="nc" id="L443">			txmlSB.append(Constants.MANIFEST_SHA256_EXTN);</span>
<span class="nc" id="L444">			String txmlManifestName = txmlSB.toString();</span>
<span class="nc" id="L445">			Map&lt;String, Object&gt; returnMap = PullUtils.pullMethod(headerXmlSHA256Url,txmlManifestName,downloadDir);</span>
			
<span class="nc bnc" id="L447" title="All 2 branches missed.">			if(returnMap.containsKey(&quot;file&quot;)){</span>
<span class="nc" id="L448">				file = (File) returnMap.get(&quot;file&quot;);</span>
			}else {
<span class="nc" id="L450">				file = new java.io.File(downloadDir + Constants.BACK_SLASH+ txmlManifestName);</span>
			}
		}
<span class="nc" id="L453">		return file;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>